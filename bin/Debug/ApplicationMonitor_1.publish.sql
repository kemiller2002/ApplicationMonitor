/*
Deployment script for ApplicationMonitor

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "ApplicationMonitor"
:setvar DefaultFilePrefix "ApplicationMonitor"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL12.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL12.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Creating [dbo].[MiniProfilerClientTimings]...';


GO
CREATE TABLE [dbo].[MiniProfilerClientTimings] (
    [RowId]          INT              IDENTITY (1, 1) NOT NULL,
    [MiniProfilerId] UNIQUEIDENTIFIER NOT NULL,
    [Name]           NVARCHAR (200)   NOT NULL,
    [Start]          DECIMAL (7, 1)   NULL,
    [Duration]       DECIMAL (7, 1)   NULL,
    CONSTRAINT [PK_MiniProfilerClientTimings] PRIMARY KEY CLUSTERED ([RowId] ASC)
);


GO
PRINT N'Creating [dbo].[MiniProfilerClientTimings].[IX_MiniProfilerClientTimings_MiniProfilerId]...';


GO
CREATE NONCLUSTERED INDEX [IX_MiniProfilerClientTimings_MiniProfilerId]
    ON [dbo].[MiniProfilerClientTimings]([MiniProfilerId] ASC);


GO
PRINT N'Creating [dbo].[MiniProfilers]...';


GO
CREATE TABLE [dbo].[MiniProfilers] (
    [Id]                                   UNIQUEIDENTIFIER NOT NULL,
    [Name]                                 NVARCHAR (200)   NOT NULL,
    [Started]                              DATETIME         NOT NULL,
    [MachineName]                          NVARCHAR (100)   NULL,
    [User]                                 NVARCHAR (100)   NULL,
    [Level]                                TINYINT          NULL,
    [RootTimingId]                         UNIQUEIDENTIFIER NULL,
    [DurationMilliseconds]                 DECIMAL (7, 1)   NOT NULL,
    [DurationMillisecondsInSql]            DECIMAL (7, 1)   NULL,
    [HasSqlTimings]                        BIT              NOT NULL,
    [HasDuplicateSqlTimings]               BIT              NOT NULL,
    [HasTrivialTimings]                    BIT              NOT NULL,
    [HasAllTrivialTimings]                 BIT              NOT NULL,
    [TrivialDurationThresholdMilliseconds] DECIMAL (5, 1)   NULL,
    [HasUserViewed]                        BIT              NOT NULL,
    CONSTRAINT [PK_MiniProfilers] PRIMARY KEY NONCLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating [dbo].[MiniProfilers].[IX_MiniProfilers_User_HasUserViewed_Includes]...';


GO
CREATE NONCLUSTERED INDEX [IX_MiniProfilers_User_HasUserViewed_Includes]
    ON [dbo].[MiniProfilers]([User] ASC, [HasUserViewed] ASC)
    INCLUDE([Id], [Started]);


GO
PRINT N'Creating [dbo].[MiniProfilerSqlTimingParameters]...';


GO
CREATE TABLE [dbo].[MiniProfilerSqlTimingParameters] (
    [RowId]             INT              IDENTITY (1, 1) NOT NULL,
    [MiniProfilerId]    UNIQUEIDENTIFIER NOT NULL,
    [ParentSqlTimingId] UNIQUEIDENTIFIER NOT NULL,
    [Name]              NVARCHAR (130)   NOT NULL,
    [DbType]            NVARCHAR (50)    NULL,
    [Size]              INT              NULL,
    [Value]             NVARCHAR (MAX)   NULL,
    CONSTRAINT [PK_MiniProfilerSqlTimingParameters] PRIMARY KEY CLUSTERED ([RowId] ASC)
);


GO
PRINT N'Creating [dbo].[MiniProfilerSqlTimingParameters].[IX_MiniProfilerSqlTimingParameters_MiniProfilerId]...';


GO
CREATE NONCLUSTERED INDEX [IX_MiniProfilerSqlTimingParameters_MiniProfilerId]
    ON [dbo].[MiniProfilerSqlTimingParameters]([MiniProfilerId] ASC);


GO
PRINT N'Creating [dbo].[MiniProfilerSqlTimings]...';


GO
CREATE TABLE [dbo].[MiniProfilerSqlTimings] (
    [RowId]                          INT              IDENTITY (1, 1) NOT NULL,
    [Id]                             UNIQUEIDENTIFIER NOT NULL,
    [MiniProfilerId]                 UNIQUEIDENTIFIER NOT NULL,
    [ParentTimingId]                 UNIQUEIDENTIFIER NOT NULL,
    [ExecuteType]                    TINYINT          NOT NULL,
    [StartMilliseconds]              DECIMAL (7, 1)   NOT NULL,
    [DurationMilliseconds]           DECIMAL (7, 1)   NOT NULL,
    [FirstFetchDurationMilliseconds] DECIMAL (7, 1)   NULL,
    [IsDuplicate]                    BIT              NOT NULL,
    [StackTraceSnippet]              NVARCHAR (200)   NOT NULL,
    [CommandString]                  NVARCHAR (MAX)   NOT NULL,
    CONSTRAINT [PK_MiniProfilerSqlTimings] PRIMARY KEY CLUSTERED ([RowId] ASC)
);


GO
PRINT N'Creating [dbo].[MiniProfilerSqlTimings].[IX_MiniProfilerSqlTimings_MiniProfilerId]...';


GO
CREATE NONCLUSTERED INDEX [IX_MiniProfilerSqlTimings_MiniProfilerId]
    ON [dbo].[MiniProfilerSqlTimings]([MiniProfilerId] ASC);


GO
PRINT N'Creating [dbo].[MiniProfilerTimings]...';


GO
CREATE TABLE [dbo].[MiniProfilerTimings] (
    [RowId]                               INT              IDENTITY (1, 1) NOT NULL,
    [Id]                                  UNIQUEIDENTIFIER NOT NULL,
    [MiniProfilerId]                      UNIQUEIDENTIFIER NOT NULL,
    [ParentTimingId]                      UNIQUEIDENTIFIER NULL,
    [Name]                                NVARCHAR (200)   NOT NULL,
    [Depth]                               SMALLINT         NOT NULL,
    [StartMilliseconds]                   DECIMAL (7, 1)   NOT NULL,
    [DurationMilliseconds]                DECIMAL (7, 1)   NOT NULL,
    [DurationWithoutChildrenMilliseconds] DECIMAL (7, 1)   NOT NULL,
    [SqlTimingsDurationMilliseconds]      DECIMAL (7, 1)   NULL,
    [IsRoot]                              BIT              NOT NULL,
    [HasChildren]                         BIT              NOT NULL,
    [IsTrivial]                           BIT              NOT NULL,
    [HasSqlTimings]                       BIT              NOT NULL,
    [HasDuplicateSqlTimings]              BIT              NOT NULL,
    [ExecutedReaders]                     SMALLINT         NOT NULL,
    [ExecutedScalars]                     SMALLINT         NOT NULL,
    [ExecutedNonQueries]                  SMALLINT         NOT NULL,
    CONSTRAINT [PK_MiniProfilerTimings] PRIMARY KEY CLUSTERED ([RowId] ASC)
);


GO
PRINT N'Creating [dbo].[MiniProfilerTimings].[IX_MiniProfilerTimings_MiniProfilerId]...';


GO
CREATE NONCLUSTERED INDEX [IX_MiniProfilerTimings_MiniProfilerId]
    ON [dbo].[MiniProfilerTimings]([MiniProfilerId] ASC);


GO
PRINT N'Update complete.';


GO
